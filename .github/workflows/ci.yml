name: ci

on:
  push:
    branches:
      - master

jobs:
  ci:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest]
        node: [14]

    steps:
      - name: Checkout ğŸ›
        uses: actions/checkout@master

      - name: Setup node env ğŸ—
        uses: actions/setup-node@v2.1.2
        with:
          node-version: ${{ matrix.node }}
          check-latest: true

      - name: Cache node_modules ğŸ“¦
        uses: actions/cache@v2
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies ğŸ‘¨ğŸ»â€ğŸ’»
        run: npm ci

      - name: Run build
        run: npm run build

      # git configë¡œ ì´ë©”ì¼ê³¼ ì´ë¦„ì„ ì„¤ì •í•œë‹¤. ê·¸ ê°’ë“¤ì€ github contextì—ì„œ ê°€ì ¸ì˜¨ë‹¤.
      - name: git config
        env:
          USER_NAME: ${{ github.event.pusher.name }}
          USER_EMAIL: ${{ github.event.pusher.email }}
        run: |
          git config --global user.email "$USER_EMAIL"
          git config --global user.name "$USER_NAME"

      # deploy ë¸Œëœì¹˜ë¡œ checkout
      # git pull origin deploy --allow-unrelated-histories
      - name: checkout deploy branch
        run: |
          git checkout -b deploy
          

      # ê¸°ì¡´ deploy ì›ê²© ë¸Œëœì¹˜ ì‚­ì œ ë° 
      # ì»¤ë°‹ ë‚´ìš©ì€ ì œì¼ ìµœê·¼ ì»¤ë°‹ ë©”ì‹œì§€
      - name: push changed files
        run: |
          git push origin --delete deploy
          git add .
          git commit -m "$(git -C ../components_test/ log --format=%B -n 1)"
          git push origin deploy
